<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Éù„É¢„Éâ„Éº„É≠„Çø„Ç§„Éû„Éº</title>

    <!-- PWAÂØæÂøú -->
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#ef4444" />

    <!-- „Ç¢„Ç§„Ç≥„É≥ -->
    <link rel="icon" type="image/png" href="https://emojicdn.elk.sh/üçÖ" />
    <link rel="apple-touch-icon" href="https://emojicdn.elk.sh/üçÖ?size=180" />

    <!-- iOS PWAÂØæÂøú -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="„Éù„É¢„Éâ„Éº„É≠" />

    <!-- Tailwind CSS -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

    <style>
        .timer-circle {
            transform: rotate(-90deg);
        }
        .dark {
            color-scheme: dark;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen transition-colors duration-200">
    <!-- Ë®≠ÂÆö„Éú„Çø„É≥ -->
    <div class="fixed top-4 right-4 z-10">
        <button id="settingsBtn" class="p-2 bg-white dark:bg-gray-800 rounded-full shadow-lg hover:shadow-xl transition-shadow">
            ‚öôÔ∏è
        </button>
    </div>

    <!-- Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´ -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-md">
            <h2 class="text-xl font-bold mb-4">Ë®≠ÂÆö</h2>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">‰ΩúÊ•≠ÊôÇÈñìÔºàÂàÜÔºâ</label>
                    <input type="number" id="workDuration" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700" min="1" max="60" value="25">
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2">‰ºëÊÜ©ÊôÇÈñìÔºàÂàÜÔºâ</label>
                    <input type="number" id="breakDuration" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700" min="1" max="30" value="5">
                </div>

                <div class="flex items-center justify-between">
                    <label class="text-sm font-medium">„ÉÄ„Éº„ÇØ„É¢„Éº„Éâ</label>
                    <button id="darkModeToggle" class="relative inline-flex h-6 w-11 items-center rounded-full bg-gray-200 dark:bg-blue-600 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform dark:translate-x-6"></span>
                    </button>
                </div>

                <div class="flex items-center justify-between pt-4">
                    <span class="text-sm text-gray-500">„Éá„Éê„ÉÉ„Ç∞„É¢„Éº„Éâ</span>
                    <button id="debugModeToggle" class="relative inline-flex h-6 w-11 items-center rounded-full bg-gray-200 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                        <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform"></span>
                    </button>
                </div>
            </div>

            <div class="flex gap-2 mt-6">
                <button id="saveSettings" class="flex-1 bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 transition-colors">‰øùÂ≠ò</button>
                <button id="cancelSettings" class="flex-1 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-300 py-2 px-4 rounded-md hover:bg-gray-400 dark:hover:bg-gray-500 transition-colors">„Ç≠„É£„É≥„Çª„É´</button>
            </div>
        </div>
    </div>

    <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
    <div class="container mx-auto px-4 py-8 max-w-md">
        <!-- „Éà„ÉÉ„ÉóÁîªÈù¢ -->
        <div id="topScreen" class="text-center">
            <div class="mb-8">
                <h1 class="text-4xl font-bold mb-2">üçÖ</h1>
                <h2 class="text-2xl font-bold">„Éù„É¢„Éâ„Éº„É≠„Çø„Ç§„Éû„Éº</h2>
            </div>

            <div class="space-y-4">
                <button id="startWorkBtn" class="w-full bg-red-500 text-white py-4 px-6 rounded-lg text-lg font-semibold hover:bg-red-600 transition-colors shadow-lg">
                    ‰ΩúÊ•≠„ÇíÈñãÂßã
                </button>
                <button id="startBreakBtn" class="w-full bg-green-500 text-white py-4 px-6 rounded-lg text-lg font-semibold hover:bg-green-600 transition-colors shadow-lg">
                    ‰ºëÊÜ©„ÇíÈñãÂßã
                </button>
            </div>
        </div>

        <!-- ‰ΩúÊ•≠ÁîªÈù¢ -->
        <div id="workScreen" class="hidden text-center">
            <h2 class="text-2xl font-bold mb-6">üçÖ ‰ΩúÊ•≠‰∏≠</h2>

            <!-- „Çø„Ç§„Éû„ÉºË°®Á§∫ -->
            <div class="relative w-64 h-64 mx-auto mb-8">
                <button id="workTimerBtn" class="absolute inset-0 w-full h-full rounded-full hover:bg-gray-500 hover:bg-opacity-5 dark:hover:bg-gray-800 dark:hover:bg-opacity-30 transition-colors">
                    <svg class="w-full h-full timer-circle" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="45" fill="none" stroke="#e5e7eb" stroke-width="8"/>
                        <circle id="workProgress" cx="50" cy="50" r="45" fill="none" stroke="#ef4444" stroke-width="8"
                                stroke-dasharray="283" stroke-dashoffset="283" stroke-linecap="round"/>
                    </svg>
                    <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                        <span id="workTimeDisplay" class="text-3xl font-bold">25:00</span>
                        <div id="workStatusDisplay" class="text-sm text-gray-500 mt-1">‰∏ÄÊôÇÂÅúÊ≠¢‰∏≠</div>
                    </div>
                </button>
            </div>

            <!-- „Çø„Çπ„ÇØÁÆ°ÁêÜ -->
            <div class="text-left space-y-6">
                <div>
                    <h3 class="font-semibold mb-2">„Åì„ÅÆ‰ΩúÊ•≠„Åß„ÇÑ„Çã„Åì„Å®</h3>
                    <div id="currentTasks" class="space-y-2"></div>
                    <button id="addCurrentTask" class="text-blue-500 hover:text-blue-600 text-sm">+ „Çø„Çπ„ÇØ„ÇíËøΩÂä†</button>
                </div>

                <div>
                    <h3 class="font-semibold mb-2">Ê¨°„ÅÆ‰ΩúÊ•≠„Åß„ÇÑ„Çã„Åì„Å®</h3>
                    <div id="nextTasks" class="space-y-2"></div>
                    <button id="addNextTask" class="text-blue-500 hover:text-blue-600 text-sm">+ „Çø„Çπ„ÇØ„ÇíËøΩÂä†</button>
                </div>
            </div>

            <button id="resetFromWork" class="w-full mt-8 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                „É™„Çª„ÉÉ„Éà
            </button>
        </div>

        <!-- ‰ºëÊÜ©ÁîªÈù¢ -->
        <div id="breakScreen" class="hidden text-center">
            <h2 class="text-2xl font-bold mb-6">‚òï ‰ºëÊÜ©‰∏≠</h2>

            <!-- „Çø„Ç§„Éû„ÉºË°®Á§∫ -->
            <div class="relative w-64 h-64 mx-auto mb-8">
                <button id="breakTimerBtn" class="absolute inset-0 w-full h-full rounded-full hover:bg-gray-500 hover:bg-opacity-5 dark:hover:bg-gray-800 dark:hover:bg-opacity-30 transition-colors">
                    <svg class="w-full h-full timer-circle" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="45" fill="none" stroke="#e5e7eb" stroke-width="8"/>
                        <circle id="breakProgress" cx="50" cy="50" r="45" fill="none" stroke="#10b981" stroke-width="8"
                                stroke-dasharray="283" stroke-dashoffset="283" stroke-linecap="round"/>
                    </svg>
                    <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                        <span id="breakTimeDisplay" class="text-3xl font-bold">05:00</span>
                        <div id="breakStatusDisplay" class="text-sm text-gray-500 mt-1">Âãï‰Ωú‰∏≠</div>
                    </div>
                </button>
            </div>

            <!-- „Çø„Çπ„ÇØÁÆ°ÁêÜ -->
            <div class="text-left space-y-6">
                <div>
                    <h3 class="font-semibold mb-2">Ê¨°„ÅÆ‰ΩúÊ•≠„Åß„ÇÑ„Çã„Åì„Å®</h3>
                    <div id="nextTasksBreak" class="space-y-2"></div>
                    <button id="addNextTaskBreak" class="text-blue-500 hover:text-blue-600 text-sm">+ „Çø„Çπ„ÇØ„ÇíËøΩÂä†</button>
                </div>
            </div>

            <button id="resetFromBreak" class="w-full mt-8 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                „É™„Çª„ÉÉ„Éà
            </button>
        </div>
    </div>

    <script>
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let currentScreen = 'top';
        let timer = null;
        let timeLeft = 0;
        let isRunning = false;
        let wakeLock = null;
        let workDuration = 25;
        let breakDuration = 5;
        let debugMode = false;

        // „Çø„Çπ„ÇØÁÆ°ÁêÜ
        let currentTasks = [];
        let nextTasks = [];

        // DOMË¶ÅÁ¥†
        const screens = {
            top: document.getElementById('topScreen'),
            work: document.getElementById('workScreen'),
            break: document.getElementById('breakScreen')
        };

        // ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', async () => {
            loadSettings();
            setupEventListeners();
            setupServiceWorker();
            showScreen('top');
        });

        // Ë®≠ÂÆö„ÅÆË™≠„ÅøËæº„Åø
        function loadSettings() {
            const savedWorkDuration = localStorage.getItem('workDuration');
            const savedBreakDuration = localStorage.getItem('breakDuration');
            const savedDarkMode = localStorage.getItem('darkMode');
            const savedDebugMode = localStorage.getItem('debugMode');
            const savedCurrentTasks = localStorage.getItem('currentTasks');
            const savedNextTasks = localStorage.getItem('nextTasks');

            if (savedWorkDuration) {
                workDuration = parseInt(savedWorkDuration);
                document.getElementById('workDuration').value = workDuration;
            }

            if (savedBreakDuration) {
                breakDuration = parseInt(savedBreakDuration);
                document.getElementById('breakDuration').value = breakDuration;
            }

            if (savedDebugMode === 'true') {
                debugMode = true;
                document.getElementById('debugModeToggle').classList.add('bg-gray-600');
                document.getElementById('debugModeToggle').querySelector('span').classList.add('translate-x-6');
                workDuration = 0.1; // 6Áßí
                breakDuration = 0.05; // 3Áßí
            }

            if (savedDarkMode === 'true') {
                document.documentElement.classList.add('dark');
                updateDarkModeToggle(true);
            }

            if (savedCurrentTasks) {
                currentTasks = JSON.parse(savedCurrentTasks);
            }

            if (savedNextTasks) {
                nextTasks = JSON.parse(savedNextTasks);
            }

            renderTasks();
        }

        // Ë®≠ÂÆö„ÅÆ‰øùÂ≠ò
        function saveSettings() {
            localStorage.setItem('workDuration', workDuration);
            localStorage.setItem('breakDuration', breakDuration);
            localStorage.setItem('darkMode', document.documentElement.classList.contains('dark'));
            localStorage.setItem('debugMode', debugMode);
            localStorage.setItem('currentTasks', JSON.stringify(currentTasks));
            localStorage.setItem('nextTasks', JSON.stringify(nextTasks));
        }

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅÆË®≠ÂÆö
        function setupEventListeners() {
            // Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´
            document.getElementById('settingsBtn').addEventListener('click', openSettings);
            document.getElementById('saveSettings').addEventListener('click', saveSettingsModal);
            document.getElementById('cancelSettings').addEventListener('click', closeSettings);
            document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);
            document.getElementById('debugModeToggle').addEventListener('click', toggleDebugMode);

            // ÁîªÈù¢ÈÅ∑Áßª
            document.getElementById('startWorkBtn').addEventListener('click', () => startWork());
            document.getElementById('startBreakBtn').addEventListener('click', () => startBreak());
            document.getElementById('resetFromWork').addEventListener('click', resetToTop);
            document.getElementById('resetFromBreak').addEventListener('click', resetToTop);

            // „Çø„Ç§„Éû„ÉºÂà∂Âæ°
            document.getElementById('workTimerBtn').addEventListener('click', toggleWorkTimer);
            document.getElementById('breakTimerBtn').addEventListener('click', toggleBreakTimer);

            // „Çø„Çπ„ÇØÁÆ°ÁêÜ
            document.getElementById('addCurrentTask').addEventListener('click', () => addTask('current'));
            document.getElementById('addNextTask').addEventListener('click', () => addTask('next'));
            document.getElementById('addNextTaskBreak').addEventListener('click', () => addTask('next'));

            // „É¢„Éº„ÉÄ„É´Â§ñ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
            document.getElementById('settingsModal').addEventListener('click', (e) => {
                if (e.target.id === 'settingsModal') {
                    closeSettings();
                }
            });
        }

        // „Çµ„Éº„Éì„Çπ„ÉØ„Éº„Ç´„Éº„ÅÆË®≠ÂÆö
        async function setupServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    await navigator.serviceWorker.register('service-worker.js');
                } catch (error) {
                    console.log('Service Worker registration failed:', error);
                }
            }
        }

        // ÁîªÈù¢Ë°®Á§∫Âà∂Âæ°
        function showScreen(screenName) {
            Object.values(screens).forEach(screen => screen.classList.add('hidden'));
            screens[screenName].classList.remove('hidden');
            currentScreen = screenName;
        }

        // ‰ΩúÊ•≠ÈñãÂßã
        function startWork() {
            showScreen('work');
            timeLeft = debugMode ? 6 : workDuration * 60; // „Éá„Éê„ÉÉ„Ç∞„É¢„Éº„Éâ„ÅØ6Áßí
            updateWorkDisplay();
            updateTimerStatus();
            renderTasks();
        }

        // ‰ºëÊÜ©ÈñãÂßã
        function startBreak() {
            showScreen('break');
            timeLeft = debugMode ? 3 : breakDuration * 60; // „Éá„Éê„ÉÉ„Ç∞„É¢„Éº„Éâ„ÅØ3Áßí
            updateBreakDisplay();
            updateTimerStatus();
            renderTasks();
            startTimer('break');
            playSound();
            requestWakeLock();
        }

        // „Çø„Ç§„Éû„ÉºÈñãÂßã/ÂÅúÊ≠¢
        function toggleWorkTimer() {
            if (isRunning) {
                stopTimer();
            } else {
                startTimer('work');
                playSound();
                requestWakeLock();
            }
        }

        function toggleBreakTimer() {
            if (isRunning) {
                stopTimer();
            } else {
                startTimer('break');
            }
        }

        // „Çø„Ç§„Éû„ÉºÂà∂Âæ°
        function startTimer(type) {
            if (isRunning) return;

            isRunning = true;
            updateTimerStatus();
            timer = setInterval(() => {
                timeLeft--;

                if (type === 'work') {
                    updateWorkDisplay();
                } else {
                    updateBreakDisplay();
                }

                if (timeLeft <= 0) {
                    stopTimer();
                    if (type === 'work') {
                        // ‰ΩúÊ•≠ÁµÇ‰∫Ü -> ‰ºëÊÜ©ÈñãÂßã
                        playSound();
                        showScreen('break');
                        timeLeft = debugMode ? 3 : breakDuration * 60;
                        updateBreakDisplay();
                        startTimer('break');
                    } else {
                        // ‰ºëÊÜ©ÁµÇ‰∫Ü -> ‰ΩúÊ•≠ÁîªÈù¢Ôºà‰∏ÄÊôÇÂÅúÊ≠¢Áä∂ÊÖãÔºâ
                        playSound();
                        clearCurrentTasks();
                        moveNextTasksToCurrent();
                        showScreen('work');
                        timeLeft = debugMode ? 6 : workDuration * 60;
                        updateWorkDisplay();
                        updateTimerStatus();
                        renderTasks();
                        releaseWakeLock();
                    }
                }
            }, 1000);
        }

        function stopTimer() {
            if (timer) {
                clearInterval(timer);
                timer = null;
            }
            isRunning = false;
            updateTimerStatus();
        }

        // Ë°®Á§∫Êõ¥Êñ∞
        function updateWorkDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('workTimeDisplay').textContent =
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            const totalTime = debugMode ? 6 : workDuration * 60;
            const progress = (totalTime - timeLeft) / totalTime;
            const circumference = 2 * Math.PI * 45;
            const offset = circumference - (progress * circumference);
            document.getElementById('workProgress').style.strokeDashoffset = offset;
        }

        function updateTimerStatus() {
            if (currentScreen === 'work') {
                const statusElement = document.getElementById('workStatusDisplay');
                statusElement.textContent = isRunning ? 'Âãï‰Ωú‰∏≠' : '‰∏ÄÊôÇÂÅúÊ≠¢‰∏≠';
                statusElement.className = isRunning ? 'text-sm text-green-600 mt-1' : 'text-sm text-gray-500 mt-1';
            } else if (currentScreen === 'break') {
                const statusElement = document.getElementById('breakStatusDisplay');
                statusElement.textContent = isRunning ? 'Âãï‰Ωú‰∏≠' : '‰∏ÄÊôÇÂÅúÊ≠¢‰∏≠';
                statusElement.className = isRunning ? 'text-sm text-green-600 mt-1' : 'text-sm text-gray-500 mt-1';
            }
        }

        function updateBreakDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('breakTimeDisplay').textContent =
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            const totalTime = debugMode ? 3 : breakDuration * 60;
            const progress = (totalTime - timeLeft) / totalTime;
            const circumference = 2 * Math.PI * 45;
            const offset = circumference - (progress * circumference);
            document.getElementById('breakProgress').style.strokeDashoffset = offset;
        }

        // Èü≥„ÅÆÂÜçÁîü
        function playSound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        }

        // Wake Lock
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                }
            } catch (err) {
                console.log('Wake Lock failed:', err);
            }
        }

        function releaseWakeLock() {
            if (wakeLock) {
                wakeLock.release();
                wakeLock = null;
            }
        }

        // „É™„Çª„ÉÉ„Éà
        function resetToTop() {
            stopTimer();
            releaseWakeLock();
            saveSettings();
            showScreen('top');
        }

        // Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´
        function openSettings() {
            document.getElementById('workDuration').value = debugMode ? 25 : workDuration;
            document.getElementById('breakDuration').value = debugMode ? 5 : breakDuration;
            document.getElementById('settingsModal').classList.remove('hidden');
            document.getElementById('settingsModal').classList.add('flex');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
            document.getElementById('settingsModal').classList.remove('flex');
        }

        function saveSettingsModal() {
            if (!debugMode) {
                workDuration = parseInt(document.getElementById('workDuration').value);
                breakDuration = parseInt(document.getElementById('breakDuration').value);
            }
            saveSettings();
            closeSettings();
        }

        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            updateDarkModeToggle(document.documentElement.classList.contains('dark'));
        }

        function updateDarkModeToggle(isDark) {
            const toggle = document.getElementById('darkModeToggle');
            const span = toggle.querySelector('span');

            if (isDark) {
                toggle.classList.add('bg-blue-600');
                toggle.classList.remove('bg-gray-200');
                span.classList.add('translate-x-6');
            } else {
                toggle.classList.remove('bg-blue-600');
                toggle.classList.add('bg-gray-200');
                span.classList.remove('translate-x-6');
            }
        }

        function toggleDebugMode() {
            debugMode = !debugMode;
            const toggle = document.getElementById('debugModeToggle');
            const span = toggle.querySelector('span');

            if (debugMode) {
                toggle.classList.add('bg-gray-600');
                toggle.classList.remove('bg-gray-200');
                span.classList.add('translate-x-6');
                workDuration = 0.1; // 6Áßí
                breakDuration = 0.05; // 3Áßí
            } else {
                toggle.classList.remove('bg-gray-600');
                toggle.classList.add('bg-gray-200');
                span.classList.remove('translate-x-6');
                workDuration = parseInt(document.getElementById('workDuration').value);
                breakDuration = parseInt(document.getElementById('breakDuration').value);
            }
        }

        // „Çø„Çπ„ÇØÁÆ°ÁêÜ
        function addTask(type) {
            const taskText = prompt('„Çø„Çπ„ÇØ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:');
            if (!taskText) return;

            const task = {
                id: Date.now(),
                text: taskText,
                completed: false
            };

            if (type === 'current') {
                currentTasks.push(task);
            } else {
                nextTasks.push(task);
            }

            renderTasks();
            saveSettings();
        }

        function toggleTask(type, id) {
            const tasks = type === 'current' ? currentTasks : nextTasks;
            const task = tasks.find(t => t.id === id);
            if (task) {
                task.completed = !task.completed;
                renderTasks();
                saveSettings();
            }
        }

        function editTask(type, id) {
            const tasks = type === 'current' ? currentTasks : nextTasks;
            const task = tasks.find(t => t.id === id);
            if (task) {
                const newText = prompt('„Çø„Çπ„ÇØ„ÇíÁ∑®ÈõÜ:', task.text);
                if (newText !== null) {
                    task.text = newText;
                    renderTasks();
                    saveSettings();
                }
            }
        }

        function deleteTask(type, id) {
            if (type === 'current') {
                currentTasks = currentTasks.filter(t => t.id !== id);
            } else {
                nextTasks = nextTasks.filter(t => t.id !== id);
            }
            renderTasks();
            saveSettings();
        }

        function renderTasks() {
            renderTaskList('currentTasks', currentTasks, 'current');
            renderTaskList('nextTasks', nextTasks, 'next');
            renderTaskList('nextTasksBreak', nextTasks, 'next');
        }

        function renderTaskList(containerId, tasks, type) {
            const container = document.getElementById(containerId);
            if (!container) return;

            container.innerHTML = '';

            tasks.forEach(task => {
                const taskElement = document.createElement('div');
                taskElement.className = 'flex items-center gap-2 p-2 bg-gray-100 dark:bg-gray-700 rounded';

                taskElement.innerHTML = `
                    <input type="checkbox" ${task.completed ? 'checked' : ''}
                           onchange="toggleTask('${type}', ${task.id})"
                           class="rounded">
                    <span class="flex-1 ${task.completed ? 'line-through text-gray-500' : ''}">${task.text}</span>
                    <button onclick="editTask('${type}', ${task.id})" class="text-blue-500 hover:text-blue-600">‚úèÔ∏è</button>
                    <button onclick="deleteTask('${type}', ${task.id})" class="text-red-500 hover:text-red-600">üóëÔ∏è</button>
                `;

                container.appendChild(taskElement);
            });
        }

        function moveNextTasksToCurrent() {
            currentTasks = [...nextTasks];
            nextTasks = [];
            renderTasks();
            saveSettings();
        }

        function clearCurrentTasks() {
            currentTasks = [];
            renderTasks();
            saveSettings();
        }

        // „Éö„Éº„Ç∏Èõ¢ËÑ±ÊôÇ„ÅÆÂá¶ÁêÜ
        window.addEventListener('beforeunload', () => {
            releaseWakeLock();
            saveSettings();
        });

        // „Éö„Éº„Ç∏Ë°®Á§∫Âæ©Â∏∞ÊôÇ„ÅÆÂá¶ÁêÜ
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible' && isRunning) {
                requestWakeLock();
            }
        });
    </script>
</body>
</html>