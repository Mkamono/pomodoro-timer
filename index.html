<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ã‚¿ã‚¤ãƒãƒ¼</title>
    <meta name="description" content="25åˆ†ã®ä½œæ¥­ã¨5åˆ†ã®ä¼‘æ†©ã‚’ç¹°ã‚Šè¿”ã™ã‚·ãƒ³ãƒ—ãƒ«ãªãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ã‚¿ã‚¤ãƒãƒ¼" />

    <!-- PWAå¯¾å¿œ -->
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#ef4444" />

    <!-- ã‚¢ã‚¤ã‚³ãƒ³ -->
    <link rel="icon" type="image/png" href="https://emojicdn.elk.sh/ğŸ…" />
    <link rel="apple-touch-icon" href="https://emojicdn.elk.sh/ğŸ…?size=180" />

    <!-- iOS PWAå¯¾å¿œ -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­" />

    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  </head>
  <body class="bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-900 dark:to-gray-800 h-[100dvh] overflow-hidden flex items-center justify-center py-2 px-4 transition-colors duration-300">
    <div class="w-full max-w-md">
      <!-- ãƒ¡ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰ -->
      <div class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl p-6 md:p-12 transition-colors duration-300">
        <!-- ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ -->
        <div class="flex justify-end gap-2 mb-3">
          <button
            id="debugToggle"
            onclick="toggleDebugMode()"
            class="p-2 rounded-lg bg-orange-200 dark:bg-orange-700 hover:bg-orange-300 dark:hover:bg-orange-600 transition duration-200"
            aria-label="ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ"
          >
            <span id="debugIcon">ğŸ”§</span>
          </button>
          <button
            id="themeToggle"
            onclick="toggleTheme()"
            class="p-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition duration-200"
            aria-label="ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆ"
          >
            <span id="themeIcon">ğŸŒ™</span>
          </button>
        </div>

        <!-- ã‚¿ã‚¤ãƒˆãƒ« -->
        <h1 class="text-3xl md:text-4xl font-bold text-center mb-6 text-gray-800 dark:text-white">
          ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ã‚¿ã‚¤ãƒãƒ¼
        </h1>

        <!-- åˆæœŸé¸æŠç”»é¢ -->
        <div id="initialChoice" class="space-y-4">
          <p class="text-center text-gray-600 dark:text-gray-300 mb-6">ä½•ã‹ã‚‰å§‹ã‚ã¾ã™ã‹ï¼Ÿ</p>
          <button
            onclick="startWithWork()"
            class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-4 px-6 rounded-xl transition duration-200 transform hover:scale-105"
          >
            <span id="workButtonText">ğŸ¯ ä½œæ¥­ã‹ã‚‰é–‹å§‹ (25åˆ†)</span>
          </button>
          <button
            onclick="startWithBreak()"
            class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-xl transition duration-200 transform hover:scale-105"
          >
            <span id="breakButtonText">â˜• ä¼‘æ†©ã‹ã‚‰é–‹å§‹ (5åˆ†)</span>
          </button>
        </div>

        <!-- ã‚¿ã‚¤ãƒãƒ¼ç”»é¢ -->
        <div id="timerView" class="hidden">
          <!-- ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤º -->
          <div class="text-center mb-4">
            <span
              id="modeDisplay"
              class="inline-block px-6 py-2 rounded-full text-white font-bold text-lg"
            ></span>
          </div>

          <!-- ã‚¿ã‚¹ã‚¯è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
          <div id="taskDisplayArea" class="mb-4 hidden">
            <div class="bg-blue-50 dark:bg-blue-900/30 border-l-4 border-blue-500 dark:border-blue-400 p-3 rounded">
              <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">ã“ã®æ™‚é–“ã§ã‚„ã‚‹ã“ã¨</p>
              <p id="taskText" class="font-medium text-gray-800 dark:text-gray-200"></p>
            </div>
          </div>

          <!-- ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤º -->
          <div class="text-center mb-6">
            <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ã‚µãƒ¼ã‚¯ãƒ«ã¨ã‚¿ã‚¤ãƒãƒ¼ -->
            <div class="relative inline-block">
              <!-- SVGã‚µãƒ¼ã‚¯ãƒ« -->
              <svg class="transform -rotate-90" width="240" height="240">
                <!-- èƒŒæ™¯ã‚µãƒ¼ã‚¯ãƒ« -->
                <circle
                  cx="120"
                  cy="120"
                  r="100"
                  stroke="#e5e7eb"
                  stroke-width="12"
                  fill="none"
                />
                <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ã‚µãƒ¼ã‚¯ãƒ« -->
                <circle
                  id="progressCircle"
                  cx="120"
                  cy="120"
                  r="100"
                  stroke="#93c5fd"
                  stroke-width="12"
                  fill="none"
                  stroke-linecap="round"
                  style="transition: stroke-dashoffset 0.5s ease, stroke 0.3s ease;"
                />
              </svg>
              <!-- ã‚¿ã‚¤ãƒãƒ¼æ™‚é–“è¡¨ç¤ºï¼ˆã‚µãƒ¼ã‚¯ãƒ«ã®ä¸­å¤®ï¼‰ -->
              <div class="absolute inset-0 flex items-center justify-center">
                <div
                  id="timerDisplay"
                  class="text-4xl md:text-5xl font-bold text-gray-800 dark:text-white font-mono"
                >
                  25:00
                </div>
              </div>
            </div>
            <div class="text-sm text-gray-500 dark:text-gray-400 mt-4">
              ã‚µã‚¤ã‚¯ãƒ«: <span id="cycleCount">1</span>
            </div>
          </div>

          <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ -->
          <div class="flex flex-col sm:flex-row gap-3 mb-4">
            <button
              id="startButton"
              onclick="startTimer()"
              class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl transition duration-200"
            >
              â–¶ é–‹å§‹
            </button>
            <button
              id="pauseButton"
              onclick="pauseTimer()"
              class="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-6 rounded-xl transition duration-200 hidden"
            >
              â¸ ä¸€æ™‚åœæ­¢
            </button>
            <button
              onclick="resetTimer()"
              class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-xl transition duration-200"
            >
              ğŸ”„ ãƒªã‚»ãƒƒãƒˆ
            </button>
          </div>

          <!-- æ¬¡ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³è¡¨ç¤º -->
          <div class="text-center text-sm text-gray-600 dark:text-gray-400">
            æ¬¡: <span id="nextSession"></span>
          </div>
        </div>
      </div>

      <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
      <div class="text-center mt-4 text-gray-600 dark:text-gray-400 text-sm">
        <span id="footerText">ä½œæ¥­25åˆ† â†’ ä¼‘æ†©5åˆ†ã‚’ç¹°ã‚Šè¿”ã—ã¾ã™</span>
      </div>
    </div>

    <!-- ã‚¿ã‚¹ã‚¯å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="taskModal" class="hidden fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-70 flex items-start justify-center p-4 z-50 overflow-y-auto" onclick="handleModalBackgroundClick(event)">
      <div id="taskModalContent" class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8 max-w-md w-full my-auto transition-transform duration-300" onclick="event.stopPropagation()">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-4">ã“ã®æ™‚é–“ã§ã‚„ã‚‹ã“ã¨</h2>
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">ã‚¿ã‚¹ã‚¯ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä»»æ„ï¼‰<span class="text-xs ml-2">(Escã‚­ãƒ¼ã§ã‚¹ã‚­ãƒƒãƒ—)</span></p>
        <input
          type="text"
          id="modalTaskInput"
          placeholder="ä¾‹: ãƒ¬ãƒãƒ¼ãƒˆä½œæˆã€ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã€è³‡æ–™èª­ã¿è¾¼ã¿..."
          class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent mb-6"
          onkeydown="handleModalKeyDown(event)"
          onfocus="handleInputFocus()"
          onblur="handleInputBlur()"
        />
        <button
          onclick="confirmTask()"
          class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl transition duration-200"
        >
          âœ“ ç¢ºå®šã—ã¦é–‹å§‹
        </button>
      </div>
    </div>

    <script>
      // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ç®¡ç†
      function initTheme() {
        const savedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

        if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
          document.documentElement.classList.add('dark');
          updateThemeIcon(true);
        } else {
          document.documentElement.classList.remove('dark');
          updateThemeIcon(false);
        }
      }

      function toggleTheme() {
        const isDark = document.documentElement.classList.toggle('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        updateThemeIcon(isDark);
      }

      function updateThemeIcon(isDark) {
        const icon = document.getElementById('themeIcon');
        icon.textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
      }

      // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ç®¡ç†
      function toggleDebugMode() {
        isDebugMode = !isDebugMode;
        updateDebugIcon();
        updateDebugUI();
      }

      function updateDebugIcon() {
        const icon = document.getElementById('debugIcon');
        icon.textContent = isDebugMode ? 'ğŸ›' : 'ğŸ”§';
      }

      function updateDebugUI() {
        const workButtonText = document.getElementById('workButtonText');
        const breakButtonText = document.getElementById('breakButtonText');
        const footerText = document.getElementById('footerText');

        if (isDebugMode) {
          workButtonText.textContent = 'ğŸ¯ ä½œæ¥­ã‹ã‚‰é–‹å§‹ (10ç§’)';
          breakButtonText.textContent = 'â˜• ä¼‘æ†©ã‹ã‚‰é–‹å§‹ (5ç§’)';
          footerText.textContent = 'ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰: ä½œæ¥­10ç§’ â†’ ä¼‘æ†©5ç§’';
        } else {
          workButtonText.textContent = 'ğŸ¯ ä½œæ¥­ã‹ã‚‰é–‹å§‹ (25åˆ†)';
          breakButtonText.textContent = 'â˜• ä¼‘æ†©ã‹ã‚‰é–‹å§‹ (5åˆ†)';
          footerText.textContent = 'ä½œæ¥­25åˆ† â†’ ä¼‘æ†©5åˆ†ã‚’ç¹°ã‚Šè¿”ã—ã¾ã™';
        }
      }

      function getWorkTime() {
        return isDebugMode ? DEBUG_WORK_TIME : WORK_TIME;
      }

      function getBreakTime() {
        return isDebugMode ? DEBUG_BREAK_TIME : BREAK_TIME;
      }

      // Screen Wake Lockç®¡ç†
      async function requestWakeLock() {
        try {
          if ('wakeLock' in navigator) {
            wakeLock = await navigator.wakeLock.request('screen');
            console.log('Wake Lockæœ‰åŠ¹åŒ–');

            wakeLock.addEventListener('release', () => {
              console.log('Wake Lockè§£é™¤');
            });
          }
        } catch (error) {
          console.warn('Wake Lockå–å¾—ã«å¤±æ•—:', error);
        }
      }

      async function releaseWakeLock() {
        if (wakeLock) {
          try {
            await wakeLock.release();
            wakeLock = null;
            console.log('Wake Lockæ‰‹å‹•è§£é™¤');
          } catch (error) {
            console.warn('Wake Lockè§£é™¤ã«å¤±æ•—:', error);
          }
        }
      }

      // ãƒšãƒ¼ã‚¸ã®å¯è¦–æ€§å¤‰æ›´æ™‚ã«Wake Lockã‚’å†å–å¾—
      document.addEventListener('visibilitychange', async () => {
        if (wakeLock !== null && document.visibilityState === 'visible' && isRunning) {
          await requestWakeLock();
        }
      });

      // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰è¡¨ç¤º/éè¡¨ç¤ºã®æ¤œå‡ºã¨ãƒ¢ãƒ¼ãƒ€ãƒ«ä½ç½®èª¿æ•´
      function setupKeyboardHandling() {
        // Visual Viewport APIã‚’ä½¿ç”¨ï¼ˆã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
        if (window.visualViewport) {
          window.visualViewport.addEventListener('resize', handleViewportResize);
        } else {
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: windowã®resizeã‚¤ãƒ™ãƒ³ãƒˆ
          window.addEventListener('resize', handleViewportResize);
        }
      }

      function handleViewportResize() {
        const taskModal = document.getElementById('taskModal');
        const modalContent = document.getElementById('taskModalContent');

        if (!taskModal.classList.contains('hidden')) {
          const viewport = window.visualViewport || window;
          const viewportHeight = viewport.height || window.innerHeight;
          const windowHeight = window.screen.height;

          // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹ã‚’åˆ¤å®šï¼ˆãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆãŒå¤§å¹…ã«å°ã•ããªã£ãŸå ´åˆï¼‰
          const heightRatio = viewportHeight / windowHeight;
          const wasKeyboardVisible = keyboardVisible;
          keyboardVisible = heightRatio < 0.75; // 75%ä»¥ä¸‹ã«ãªã£ãŸã‚‰ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰è¡¨ç¤ºã¨åˆ¤å®š

          if (keyboardVisible && !wasKeyboardVisible) {
            // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰è¡¨ç¤ºé–‹å§‹
            adjustModalForKeyboard();
          } else if (!keyboardVisible && wasKeyboardVisible) {
            // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰éè¡¨ç¤º
            resetModalPosition();
          }
        }
      }

      function adjustModalForKeyboard() {
        const taskModal = document.getElementById('taskModal');
        const modalContent = document.getElementById('taskModalContent');
        const input = document.getElementById('modalTaskInput');

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ä¸Šéƒ¨ã«é…ç½®
        taskModal.classList.remove('items-start');
        taskModal.classList.add('items-start');
        modalContent.classList.remove('my-auto');
        modalContent.classList.add('mt-4');

        // å…¥åŠ›æ¬„ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«èª¿æ•´
        setTimeout(() => {
          input.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);
      }

      function resetModalPosition() {
        const taskModal = document.getElementById('taskModal');
        const modalContent = document.getElementById('taskModalContent');

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆ
        taskModal.classList.remove('items-start');
        taskModal.classList.add('items-start');
        modalContent.classList.remove('mt-4');
        modalContent.classList.add('my-auto');
      }

      // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãƒ»ãƒ–ãƒ©ãƒ¼å‡¦ç†
      function handleInputFocus() {
        // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã¯å°‘ã—é…å»¶ã—ã¦ã‹ã‚‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«èª¿æ•´
        setTimeout(() => {
          const input = document.getElementById('modalTaskInput');
          if (input) {
            input.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
          }
        }, 300);
      }

      function handleInputBlur() {
        // ãƒ–ãƒ©ãƒ¼æ™‚ã¯ç‰¹ã«ä½•ã‚‚ã—ãªã„ï¼ˆã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãŒé–‰ã˜ã‚‹ã®ã‚’å¾…ã¤ï¼‰
      }

      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ†ãƒ¼ãƒã‚’åˆæœŸåŒ–
      initTheme();

      // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å‡¦ç†ã®åˆæœŸåŒ–
      setupKeyboardHandling();

      // Service Workerã®ç™»éŒ²ï¼ˆPWAå¯¾å¿œï¼‰
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/pomodoro-timer/service-worker.js')
            .then((registration) => {
              console.log('Service Workerç™»éŒ²æˆåŠŸ:', registration.scope);
            })
            .catch((error) => {
              console.log('Service Workerç™»éŒ²å¤±æ•—:', error);
            });
        });
      }

      // ã‚¿ã‚¤ãƒãƒ¼ã®çŠ¶æ…‹
      let timerInterval = null;
      let timeLeft = 25 * 60; // ç§’å˜ä½
      let isRunning = false;
      let currentMode = 'work'; // 'work' or 'break'
      let cycleCount = 1;
      let currentTask = ''; // ç¾åœ¨ã®ã‚¿ã‚¹ã‚¯
      let isDebugMode = false; // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰
      let wakeLock = null; // Screen Wake Lock
      let keyboardVisible = false; // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰è¡¨ç¤ºçŠ¶æ…‹
      let originalModalPosition = null; // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å…ƒã®ä½ç½®

      const WORK_TIME = 25 * 60; // 25åˆ†
      const BREAK_TIME = 5 * 60; // 5åˆ†
      const DEBUG_WORK_TIME = 10; // ãƒ‡ãƒãƒƒã‚°: 10ç§’
      const DEBUG_BREAK_TIME = 5; // ãƒ‡ãƒãƒƒã‚°: 5ç§’
      const PROGRESS_RADIUS = 100; // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ã‚µãƒ¼ã‚¯ãƒ«ã®åŠå¾„

      // AudioContextã‚’å†åˆ©ç”¨ï¼ˆãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢ï¼‰
      let audioContext = null;

      // éŸ³å£°ã‚’å†ç”Ÿã™ã‚‹é–¢æ•°ï¼ˆWeb Audio APIã‚’ä½¿ç”¨ï¼‰
      function playSound() {
        try {
          if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
          }

          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();

          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);

          oscillator.frequency.value = 800; // å‘¨æ³¢æ•°
          oscillator.type = 'sine';

          gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

          oscillator.start(audioContext.currentTime);
          oscillator.stop(audioContext.currentTime + 0.5);
        } catch (error) {
          console.warn('éŸ³å£°å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
        }
      }

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      function showTaskModal() {
        const modal = document.getElementById('taskModal');
        const modalInput = document.getElementById('modalTaskInput');
        modal.classList.remove('hidden');
        modalInput.value = '';

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
        keyboardVisible = false;
        resetModalPosition();

        // å°‘ã—é…å»¶ã—ã¦ã‹ã‚‰ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ï¼ˆiOSå¯¾å¿œï¼‰
        setTimeout(() => {
          modalInput.focus();
        }, 100);
      }

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éè¡¨ç¤º
      function hideTaskModal() {
        document.getElementById('taskModal').classList.add('hidden');
        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
        keyboardVisible = false;
      }

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†
      function handleModalKeyDown(event) {
        if (event.key === 'Enter') {
          confirmTask();
        } else if (event.key === 'Escape') {
          // Escã‚­ãƒ¼ã§ã‚¹ã‚­ãƒƒãƒ—ï¼ˆã‚¿ã‚¹ã‚¯ãªã—ã§é–‹å§‹ï¼‰
          confirmTask();
        }
      }

      // ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
      function handleModalBackgroundClick(event) {
        if (event.target.id === 'taskModal') {
          confirmTask(); // ã‚¿ã‚¹ã‚¯ãªã—ã§é–‹å§‹
        }
      }

      // ã‚¿ã‚¹ã‚¯ã‚’ç¢ºå®šã—ã¦ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹
      function confirmTask() {
        const modalInput = document.getElementById('modalTaskInput');
        currentTask = modalInput.value.trim();
        hideTaskModal();

        // ã‚¿ã‚¹ã‚¯è¡¨ç¤ºã‚’æ›´æ–°
        if (currentTask) {
          document.getElementById('taskText').textContent = currentTask;
          document.getElementById('taskDisplayArea').classList.remove('hidden');
        } else {
          document.getElementById('taskDisplayArea').classList.add('hidden');
        }

        // ã‚¿ã‚¤ãƒãƒ¼ã‚’è‡ªå‹•é–‹å§‹
        startTimer();
      }


      // ã‚¿ã‚¤ãƒãƒ¼åˆæœŸåŒ–ï¼ˆå…±é€šå‡¦ç†ï¼‰
      function initializeTimer(mode) {
        currentMode = mode;
        timeLeft = mode === 'work' ? getWorkTime() : getBreakTime();
        document.getElementById('initialChoice').classList.add('hidden');
        document.getElementById('timerView').classList.remove('hidden');
        updateDisplay();
        playSound();
      }

      // ä½œæ¥­ã‹ã‚‰é–‹å§‹
      function startWithWork() {
        initializeTimer('work');
        showTaskModal();
      }

      // ä¼‘æ†©ã‹ã‚‰é–‹å§‹
      function startWithBreak() {
        initializeTimer('break');
        startTimer();
      }

      // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
      function startTimer() {
        if (!isRunning) {
          isRunning = true;
          document.getElementById('startButton').classList.add('hidden');
          document.getElementById('pauseButton').classList.remove('hidden');

          // Wake Lockã‚’æœ‰åŠ¹åŒ–
          requestWakeLock();

          timerInterval = setInterval(() => {
            timeLeft--;

            if (timeLeft <= 0) {
              switchMode();
            } else {
              updateTimerDisplay();
            }
          }, 1000);
        }
      }

      // ã‚¿ã‚¤ãƒãƒ¼ä¸€æ™‚åœæ­¢
      function pauseTimer() {
        isRunning = false;
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }
        document.getElementById('startButton').classList.remove('hidden');
        document.getElementById('pauseButton').classList.add('hidden');

        // Wake Lockã‚’è§£é™¤
        releaseWakeLock();
      }

      // ã‚¿ã‚¤ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ
      function resetTimer() {
        pauseTimer();
        // Wake Lockã‚’ç¢ºå®Ÿã«è§£é™¤
        releaseWakeLock();

        // ã‚¿ã‚¤ãƒãƒ¼ãƒ“ãƒ¥ãƒ¼ã‚’éè¡¨ç¤ºã«ã—ã¦åˆæœŸé¸æŠç”»é¢ã‚’è¡¨ç¤º
        document.getElementById('timerView').classList.add('hidden');
        document.getElementById('initialChoice').classList.remove('hidden');
        // çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
        cycleCount = 1;
        timeLeft = getWorkTime();
        currentMode = 'work';
        currentTask = '';
        // ã‚¿ã‚¹ã‚¯è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
        document.getElementById('taskDisplayArea').classList.add('hidden');
      }

      // ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
      function switchMode() {
        playSound(); // éŸ³ã‚’é³´ã‚‰ã™

        if (currentMode === 'work') {
          // ä½œæ¥­â†’ä¼‘æ†©
          currentMode = 'break';
          timeLeft = getBreakTime();
          updateDisplay();
          // ä¼‘æ†©ã¯è‡ªå‹•ç¶™ç¶šï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ãªã—ï¼‰
        } else {
          // ä¼‘æ†©â†’ä½œæ¥­
          pauseTimer(); // ã‚¿ã‚¤ãƒãƒ¼ã‚’ä¸€æ™‚åœæ­¢
          currentMode = 'work';
          timeLeft = getWorkTime();
          cycleCount++;
          // æ–°ã—ã„ä½œæ¥­ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ãŸã‚ã«ã‚¿ã‚¹ã‚¯ã‚’ãƒªã‚»ãƒƒãƒˆ
          currentTask = '';
          document.getElementById('taskDisplayArea').classList.add('hidden');
          updateDisplay();
          // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã—ã¦ã‚¿ã‚¹ã‚¯å…¥åŠ›ï¼ˆç¢ºå®šæ™‚ã«ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹ï¼‰
          showTaskModal();
        }
      }

      // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ã‚µãƒ¼ã‚¯ãƒ«ã®åˆæœŸåŒ–ï¼ˆä¸€åº¦ã ã‘å®Ÿè¡Œï¼‰
      let progressCircleInitialized = false;
      function initProgressCircle() {
        if (!progressCircleInitialized) {
          const progressCircle = document.getElementById('progressCircle');
          const circumference = 2 * Math.PI * PROGRESS_RADIUS;
          progressCircle.style.strokeDasharray = circumference;
          progressCircleInitialized = true;
        }
      }

      // ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºã®ã¿æ›´æ–°ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼‰
      function updateTimerDisplay() {
        // æ™‚é–“è¡¨ç¤º
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        document.getElementById('timerDisplay').textContent =
          `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ã‚µãƒ¼ã‚¯ãƒ«æ›´æ–°
        const progressCircle = document.getElementById('progressCircle');
        const circumference = 2 * Math.PI * PROGRESS_RADIUS;
        const totalTime = currentMode === 'work' ? getWorkTime() : getBreakTime();
        const progress = timeLeft / totalTime;
        const offset = circumference * progress;
        progressCircle.style.strokeDashoffset = offset;
      }

      // å…¨ä½“ã®è¡¨ç¤ºæ›´æ–°ï¼ˆãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿æ™‚ãªã©ï¼‰
      function updateDisplay() {
        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ã‚µãƒ¼ã‚¯ãƒ«ã®åˆæœŸåŒ–
        initProgressCircle();

        // ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºã‚’æ›´æ–°
        updateTimerDisplay();

        // ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤º
        const modeDisplay = document.getElementById('modeDisplay');
        const taskDisplayArea = document.getElementById('taskDisplayArea');
        const progressCircle = document.getElementById('progressCircle');

        if (currentMode === 'work') {
          modeDisplay.textContent = 'ğŸ¯ ä½œæ¥­æ™‚é–“';
          modeDisplay.className = 'inline-block px-6 py-2 rounded-full text-white font-bold text-lg bg-red-500';
          progressCircle.style.stroke = '#ef4444'; // èµ¤è‰²ï¼ˆä½œæ¥­æ™‚é–“ï¼‰
          // ã‚¿ã‚¹ã‚¯ãŒã‚ã‚‹å ´åˆã®ã¿è¡¨ç¤º
          if (currentTask) {
            taskDisplayArea.classList.remove('hidden');
          }
        } else {
          modeDisplay.textContent = 'â˜• ä¼‘æ†©æ™‚é–“';
          modeDisplay.className = 'inline-block px-6 py-2 rounded-full text-white font-bold text-lg bg-green-600';
          progressCircle.style.stroke = '#16a34a'; // ç·‘è‰²ï¼ˆä¼‘æ†©æ™‚é–“ï¼‰
          taskDisplayArea.classList.add('hidden');
        }

        // æ¬¡ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³
        const nextSessionText = isDebugMode
          ? (currentMode === 'work' ? 'ä¼‘æ†© (5ç§’)' : 'ä½œæ¥­ (10ç§’)')
          : (currentMode === 'work' ? 'ä¼‘æ†© (5åˆ†)' : 'ä½œæ¥­ (25åˆ†)');
        document.getElementById('nextSession').textContent = nextSessionText;

        // ã‚µã‚¤ã‚¯ãƒ«æ•°
        document.getElementById('cycleCount').textContent = cycleCount;
      }
    </script>
  </body>
</html>
